## Api接口调用说明

项目增加了Api开发基类的封装，以及个人项目小程序端的接口，下面对小程序登录授权两个基础接口进行说明

### 小程序接口

#### 登录接口

> 本接口为用户登录认证接口，登录成功返回服务器session信息，该值小程序本地需要存储

##### 地址

> HOST + /api/smallapp/login

##### 请求类型

> POST

##### 请求参数

| 字段   | 数据类型 | 说明               |      |
| ------ | -------- | ------------------ | ---- |
| app_id | integer  | 应用id             | 是   |
| code   | string   | wx.login获取的code | 是   |

##### 返回参数

| 字段    | 数据类型 | 说明                                                         |
| ------- | -------- | ------------------------------------------------------------ |
| token   | string   | 用户第三方token值                                            |
| oauthed | bool     | 如用户已注册返回true, 否则返回false                          |
| user    | object   | 用户信息{ nickname : 昵称, avatar : 头像, mobile: 手机号，当且仅当oauthed为true是返回 |

##### 说明

1、 调用该接口请勿传递_user_token参数

2、 返回的token信息请本地保存, 需要登录认证的接口请在_user_token参数中携带该值

### 授权接口

> 小程序调用登录接口后，若返回值oauthed为false说明该用户未注册过，则该接口会执行注册【注册前会检测用户是否已注册关联公众号， 如果注册过则直接绑定到该用户】，然后返回用户信息；如果已注册，则直接返回用户信息。

> HOST + /api/smallapp/oauth

##### 请求类型

> POST

##### 请求参数

| 字段          | 数据类型 | 说明                                     | 必填 |
| ------------- | -------- | ---------------------------------------- | ---- |
| app_id        | integer  | 应用id                                   | 是   |
| token         | string   | token                                    | 是   |
| iv            | string   | 加密算法的初始向量                       | 是   |
| encryptedData | string   | 包括敏感数据在内的完整用户信息的加密数据 | 是   |

##### 返回参数

| 字段     | 数据类型 | 说明         |
| -------- | -------- | ------------ |
| nickname | string   | 用户昵称     |
| avatar   | string   | 用户头像地址 |
| mobile   | string   | 用户手机号   |

##### 特殊错误状态码:

| 错误码 | 说明                                                         | 特殊处理               |
| ------ | ------------------------------------------------------------ | ---------------------- |
| 8527   | 用户SESSION数据不一致即小程序当前用户和服务器session用户不一致， 服务器会删除session | 小程序需重新登录       |
| 8526   | 用户注册失败                                                 | 小程序需重新调用本接口 |
| 8525   | 更新session用户失败                                          | 小程序需重新调用本接口 |
| 8524   | 授权数据解密失败                                             | 小程序需重新登录       |

### 微信官方说明

#### 登录流程时序图

![api-login.2fcc9f35](E:/GitProjects/Documents/Image/Markdown/api-login.2fcc9f35.jpg)